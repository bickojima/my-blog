<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>作業完了報告書 - Bug #36修正・エビデンス再取得 - 2026-02-24</title>
<style>
  :root {
    --color-primary: #1e3a5f;
    --color-primary-light: #2563eb;
    --color-pass: #16a34a;
    --color-pass-bg: #dcfce7;
    --color-fail: #dc2626;
    --color-fail-bg: #fef2f2;
    --color-warn: #d97706;
    --color-warn-bg: #fef3c7;
    --color-info: #2563eb;
    --color-info-bg: #dbeafe;
    --color-border: #e2e8f0;
    --color-bg: #f8fafc;
    --color-text: #1e293b;
    --color-text-muted: #64748b;
    --radius: 8px;
    --shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
    color: var(--color-text);
    background: #f1f5f9;
    line-height: 1.7;
    font-size: 14px;
  }
  .container { max-width: 1000px; margin: 0 auto; padding: 0 24px; }

  /* Header */
  .report-header {
    background: linear-gradient(135deg, var(--color-primary) 0%, #0f172a 100%);
    color: #fff;
    padding: 40px 0 32px;
    border-bottom: 4px solid var(--color-primary-light);
  }
  .report-header h1 { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
  .report-header .doc-id { font-size: 13px; color: #94a3b8; margin-bottom: 16px; }
  .header-meta { display: flex; flex-wrap: wrap; gap: 24px; font-size: 13px; color: #cbd5e1; }
  .header-meta .label { color: #94a3b8; }

  /* Section */
  .section { padding: 24px 0; }
  .section-title {
    font-size: 18px; font-weight: 700; color: var(--color-primary);
    border-bottom: 2px solid var(--color-primary); padding-bottom: 8px; margin-bottom: 16px;
    display: flex; align-items: center; gap: 10px;
  }
  .section-num {
    display: inline-flex; align-items: center; justify-content: center;
    width: 28px; height: 28px; background: var(--color-primary); color: #fff;
    border-radius: 50%; font-size: 14px; font-weight: 700; flex-shrink: 0;
  }

  /* Card */
  .card {
    background: #fff; border-radius: var(--radius); border: 1px solid var(--color-border);
    box-shadow: var(--shadow); padding: 20px; margin-bottom: 16px;
  }
  .card h3 { font-size: 15px; font-weight: 700; color: var(--color-primary); margin-bottom: 10px; }

  /* Table */
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th {
    background: var(--color-primary); color: #fff; padding: 10px 14px;
    text-align: left; font-weight: 600; font-size: 12px; letter-spacing: 0.03em;
  }
  td { padding: 10px 14px; border-bottom: 1px solid var(--color-border); vertical-align: top; }
  tbody tr:hover { background: #f8fafc; }
  tbody tr:last-child td { border-bottom: none; }

  /* Badge */
  .badge {
    display: inline-block; padding: 2px 10px; border-radius: 9999px;
    font-size: 11px; font-weight: 700; letter-spacing: 0.04em;
  }
  .badge-pass { background: var(--color-pass-bg); color: var(--color-pass); border: 1px solid #bbf7d0; }
  .badge-fail { background: var(--color-fail-bg); color: var(--color-fail); border: 1px solid #fecaca; }
  .badge-info { background: var(--color-info-bg); color: var(--color-info); border: 1px solid #bfdbfe; }
  .badge-warn { background: var(--color-warn-bg); color: var(--color-warn); border: 1px solid #fde68a; }
  .badge-new { background: #f0fdf4; color: #15803d; border: 1px solid #86efac; }

  /* Status indicators */
  .status-ok { color: var(--color-pass); font-weight: 700; }
  .status-ng { color: var(--color-fail); font-weight: 700; }
  .status-na { color: var(--color-text-muted); }

  /* Evidence grid */
  .evidence-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
  .evidence-grid img {
    width: 100%; height: auto; border-radius: 6px;
    border: 1px solid var(--color-border); box-shadow: var(--shadow);
  }
  .evidence-label { font-size: 11px; font-weight: 700; color: var(--color-text-muted); text-align: center; margin-bottom: 4px; }

  /* Alert */
  .alert {
    padding: 14px 18px; border-radius: var(--radius); margin-bottom: 16px;
    font-size: 13px; border: 1px solid;
  }
  .alert-info { background: var(--color-info-bg); border-color: #bfdbfe; color: #1e40af; }
  .alert-warn { background: var(--color-warn-bg); border-color: #fde68a; color: #92400e; }
  .alert-pass { background: var(--color-pass-bg); border-color: #bbf7d0; color: #166534; }

  /* Footer */
  .report-footer {
    padding: 24px 0; text-align: center; color: var(--color-text-muted);
    font-size: 12px; border-top: 1px solid var(--color-border); margin-top: 24px; background: #fff;
  }

  /* Checklist */
  .checklist { list-style: none; }
  .checklist li { padding: 6px 0; display: flex; align-items: flex-start; gap: 8px; }
  .checklist li::before { content: ''; display: inline-block; width: 18px; height: 18px; border-radius: 4px; flex-shrink: 0; margin-top: 2px; }
  .checklist li.done::before { background: var(--color-pass); content: ''; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3E%3Cpath fill-rule='evenodd' d='M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z'/%3E%3C/svg%3E"); }
  .checklist li.skip::before { background: #fbbf24; }

  hr.divider { border: none; border-top: 2px solid var(--color-border); margin: 8px 0; }

  @media print {
    body { background: #fff; }
    .report-header { background: var(--color-primary); }
    .card { break-inside: avoid; }
  }
  @media (max-width: 768px) {
    .evidence-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- Header -->
<header class="report-header">
  <div class="container">
    <h1>作業完了報告書</h1>
    <p class="doc-id">Bug #36修正・CMS CRUDエビデンス再取得・ドキュメント体系更新</p>
    <div class="header-meta">
      <span><span class="label">報告日:</span> 2026-02-24</span>
      <span><span class="label">対象ブランチ:</span> staging</span>
      <span><span class="label">コミット:</span> 8be511a</span>
      <span><span class="label">ドキュメント版数:</span> v1.31</span>
      <span><span class="label">報告者:</span> Claude Code</span>
    </div>
  </div>
</header>

<!-- 1. 作業概要 -->
<section class="section">
  <div class="container">
    <h2 class="section-title"><span class="section-num">1</span> 作業概要</h2>
    <div class="card">
      <p>CMS CRUDエビデンス（T17〜T32、48枚）がすべてログイン画面のみを表示し、認証後の編集画面が撮影されていなかった不具合（Bug #36）を修正し、エビデンスを再取得した。併せて、エビデンス社内レビュー義務化・バグ修正ドキュメント反映義務化のルールを追加し、ドキュメント体系を更新した。</p>
    </div>

    <div class="card">
      <h3>作業期間・範囲</h3>
      <table>
        <tr><td style="width:180px;font-weight:600;">作業日</td><td>2026-02-23〜2026-02-24</td></tr>
        <tr><td style="font-weight:600;">影響範囲</td><td>エビデンス収集スクリプト（verify-cms-crud.mjs）、ドキュメント（DOCUMENTATION.md, CLAUDE.md）、エビデンスファイル（48 PNG）</td></tr>
        <tr><td style="font-weight:600;">プロダクトコード変更</td><td>なし（エビデンス収集基盤のみ）</td></tr>
        <tr><td style="font-weight:600;">テスト影響</td><td>518/519 PASS（1件はWindows固有のsharpファイルロック、既知問題）</td></tr>
      </table>
    </div>
  </div>
</section>

<hr class="divider">

<!-- 2. 不具合詳細と原因分析 -->
<section class="section">
  <div class="container">
    <h2 class="section-title"><span class="section-num">2</span> 不具合詳細と原因分析（Bug #36）</h2>

    <div class="card">
      <h3>現象</h3>
      <p>verify-cms-crud.mjsで取得したCMS CRUDエビデンス48枚（T17〜T32 x PC/iPad/iPhone）が、全て「GitHub でログインする」ボタンのみのログイン画面を表示。認証後のエディタ画面（フォーム入力・プレビュー・ツールバー等）が一切撮影されていなかった。</p>
    </div>

    <div class="card">
      <h3>根本原因（4つの技術的問題の複合）</h3>
      <table>
        <thead>
          <tr><th>#</th><th>問題</th><th>詳細</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td><strong>3ステップハンドシェイク未実装</strong></td>
            <td>Decap CMS OAuthは <code>authorizing:github</code> → ACK → <code>authorization:github:success</code> の3段階が必須。ステップ1-2を省略してトークンを直接送信するとCMSがメッセージを無視する</td>
          </tr>
          <tr>
            <td>2</td>
            <td><strong>page.route()のポップアップ非対応</strong></td>
            <td>Playwrightの <code>page.route()</code> はポップアップウィンドウのナビゲーションをインターセプトできない。<code>context.route()</code>（ブラウザコンテキストレベル）が必要</td>
          </tr>
          <tr>
            <td>3</td>
            <td><strong>globパターンのクエリパラメータ不一致</strong></td>
            <td><code>**/auth</code> は <code>/auth?provider=github&...</code> のようなクエリパラメータ付きURLにマッチしない</td>
          </tr>
          <tr>
            <td>4</td>
            <td><strong>クロスオリジンpostMessage拒否</strong></td>
            <td>config.ymlの <code>base_url</code> がリモートURL（staging.reiwa.casa）のままだとlocalhost上のpostMessageがオリジン不一致で拒否される</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<hr class="divider">

<!-- 3. 修正内容 -->
<section class="section">
  <div class="container">
    <h2 class="section-title"><span class="section-num">3</span> 修正内容</h2>

    <div class="card">
      <h3>コード変更一覧</h3>
      <table>
        <thead>
          <tr><th>ファイル</th><th>変更内容</th><th>種別</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><code>evidence/2026-02-23/verify-cms-crud.mjs</code></td>
            <td>
              <ul style="padding-left:16px;margin:0;">
                <li>3ステップOAuthハンドシェイクを<code>context.route()</code>で実装</li>
                <li>GitHub APIモックのルート登録順序をLIFO対応に修正（catch-all先登録→具体ルート後登録）</li>
                <li>関数マッチャー（<code>url => url.pathname === '/auth'</code>）に変更</li>
                <li>リポジトリAPIレスポンスに必須フィールド追加（id, name, owner）</li>
                <li>ブラウザクラッシュ復帰処理追加</li>
              </ul>
            </td>
            <td><span class="badge badge-info">BUG FIX</span></td>
          </tr>
          <tr>
            <td><code>CLAUDE.md</code></td>
            <td>
              <ul style="padding-left:16px;margin:0;">
                <li>ルール11: エビデンス提出前に社内レビューを実施する</li>
                <li>バグフロー5: バグ修正内容を必ずドキュメントに反映する</li>
                <li>エビデンス取得方針に社内レビュー項目追加</li>
              </ul>
            </td>
            <td><span class="badge badge-new">RULE</span></td>
          </tr>
          <tr>
            <td><code>docs/DOCUMENTATION.md</code></td>
            <td>
              <ul style="padding-left:16px;margin:0;">
                <li>Bug #36をバグ一覧（4.5章）に追加</li>
                <li>改訂履歴v1.31追加</li>
                <li>4.9.8章: エビデンス収集認証方式の技術ノート追加</li>
                <li>4.9.5章: Bug #36を過去バグ検証マトリクスに追加</li>
              </ul>
            </td>
            <td><span class="badge badge-info">DOC</span></td>
          </tr>
          <tr>
            <td><code>evidence/2026-02-23/cms-crud/*.png</code> (48枚)</td>
            <td>CMS認証後のエディタ画面スクリーンショットで全て再取得</td>
            <td><span class="badge badge-pass">EVIDENCE</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<hr class="divider">

<!-- 4. システム要件変更確認 -->
<section class="section">
  <div class="container">
    <h2 class="section-title"><span class="section-num">4</span> システム要件変更確認</h2>

    <div class="alert alert-info">
      <strong>確認結果:</strong> 今回の修正はエビデンス収集基盤（テストインフラ）のみの変更であり、プロダクトコード・システム要件（FR/CMS/NFR/SEC）への変更はありません。
    </div>

    <div class="card">
      <h3>要件影響度マトリクス</h3>
      <table>
        <thead>
          <tr><th>要件カテゴリ</th><th>件数</th><th>変更</th><th>確認結果</th></tr>
        </thead>
        <tbody>
          <tr><td>機能要件（FR-01〜FR-21）</td><td>21件</td><td class="status-na">変更なし</td><td class="status-ok">OK</td></tr>
          <tr><td>CMS要件（CMS-01〜CMS-16）</td><td>16件</td><td class="status-na">変更なし</td><td class="status-ok">OK</td></tr>
          <tr><td>非機能要件（NFR-01〜NFR-06）</td><td>6件</td><td class="status-na">変更なし</td><td class="status-ok">OK</td></tr>
          <tr><td>セキュリティ要件（SEC-01〜SEC-26）</td><td>26件</td><td class="status-na">変更なし</td><td class="status-ok">OK</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>ドキュメント・ルール変更</h3>
      <table>
        <thead>
          <tr><th>ドキュメント</th><th>変更箇所</th><th>内容</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>DOCUMENTATION.md</td>
            <td>4.5章 バグ一覧</td>
            <td>Bug #36追加（CMS CRUDエビデンス認証不具合）</td>
          </tr>
          <tr>
            <td>DOCUMENTATION.md</td>
            <td>4.9.5章 過去バグ検証</td>
            <td>Bug #36をエビデンス検証マトリクスに追加</td>
          </tr>
          <tr>
            <td>DOCUMENTATION.md</td>
            <td>4.9.8章（新規）</td>
            <td>エビデンス収集認証方式の技術ノート（3ステップハンドシェイク、Playwright制約と対策）</td>
          </tr>
          <tr>
            <td>DOCUMENTATION.md</td>
            <td>改訂履歴</td>
            <td>v1.31追加</td>
          </tr>
          <tr>
            <td>CLAUDE.md</td>
            <td>コード変更時ルール</td>
            <td>ルール11「エビデンス提出前に社内レビューを実施する」追加</td>
          </tr>
          <tr>
            <td>CLAUDE.md</td>
            <td>バグ対応フロー</td>
            <td>ルール5「バグ修正内容を必ずドキュメントに反映する」追加</td>
          </tr>
          <tr>
            <td>CLAUDE.md</td>
            <td>エビデンス取得方針</td>
            <td>社内レビュー義務化の項目追加</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<hr class="divider">

<!-- 5. エビデンス確認結果 -->
<section class="section">
  <div class="container">
    <h2 class="section-title"><span class="section-num">5</span> エビデンス確認結果（社内レビュー）</h2>

    <div class="alert alert-pass">
      <strong>レビュー結果: 合格</strong> -- 全48枚のスクリーンショットがCMS認証後のエディタ画面を正しく表示していることを確認しました。
    </div>

    <div class="card">
      <h3>レビュー観点と確認結果</h3>
      <ul class="checklist">
        <li class="done">ログインボタンではなくエディタ画面が表示されている（全48枚）</li>
        <li class="done">認証が全テストで1秒以内に完了（<code>[AUTH] CMS loaded (1s)</code>）</li>
        <li class="done">赤枠アノテーションが注目箇所に付与されている</li>
        <li class="done">PC / iPad / iPhone の3デバイスで取得されている</li>
        <li class="done">エディタUI要素（タイトル、本文、ツールバー、プレビュー）が表示されている</li>
        <li class="done">記事CRUD・画像操作・固定ページ・タグ編集の各操作が確認できる</li>
      </ul>
    </div>

    <div class="card">
      <h3>代表的なエビデンス（修正前→修正後）</h3>
      <table>
        <thead>
          <tr><th>テスト</th><th>修正前</th><th>修正後</th></tr>
        </thead>
        <tbody>
          <tr><td>T17 記事新規作成</td><td class="status-ng">ログインボタンのみ</td><td class="status-ok">フォーム入力（タイトル・本文・プレビュー表示）</td></tr>
          <tr><td>T19 記事編集</td><td class="status-ng">ログインボタンのみ</td><td class="status-ok">既存記事フィールド・公開URL表示</td></tr>
          <tr><td>T22 記事削除</td><td class="status-ng">ログインボタンのみ</td><td class="status-ok">完全削除ボタン・ラベル表示</td></tr>
          <tr><td>T26 メディアライブラリ</td><td class="status-ng">ログインボタンのみ</td><td class="status-ok">モーダル表示・アップロードボタン・カードグリッド</td></tr>
          <tr><td>T32 エディタツールバー</td><td class="status-ng">ログインボタンのみ</td><td class="status-ok">書式ボタン・テキスト選択・太字適用</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>T17: 記事新規作成フォーム（修正後）</h3>
      <div class="evidence-grid">
        <div>
          <div class="evidence-label">PC (1280x800)</div>
          <img src="cms-crud/T17-create-form_PC.png" alt="T17 - PC">
        </div>
        <div>
          <div class="evidence-label">iPad (834x1194)</div>
          <img src="cms-crud/T17-create-form_iPad.png" alt="T17 - iPad">
        </div>
        <div>
          <div class="evidence-label">iPhone (390x844)</div>
          <img src="cms-crud/T17-create-form_iPhone.png" alt="T17 - iPhone">
        </div>
      </div>
    </div>

    <div class="card">
      <h3>T26: メディアライブラリモーダル（修正後）</h3>
      <div class="evidence-grid">
        <div>
          <div class="evidence-label">PC (1280x800)</div>
          <img src="cms-crud/T26-media-library_PC.png" alt="T26 - PC">
        </div>
        <div>
          <div class="evidence-label">iPad (834x1194)</div>
          <img src="cms-crud/T26-media-library_iPad.png" alt="T26 - iPad">
        </div>
        <div>
          <div class="evidence-label">iPhone (390x844)</div>
          <img src="cms-crud/T26-media-library_iPhone.png" alt="T26 - iPhone">
        </div>
      </div>
    </div>
  </div>
</section>

<hr class="divider">

<!-- 6. テスト結果 -->
<section class="section">
  <div class="container">
    <h2 class="section-title"><span class="section-num">6</span> テスト結果</h2>

    <div class="card">
      <table>
        <thead>
          <tr><th>テスト種別</th><th>実行数</th><th>合格</th><th>不合格</th><th>結果</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Vitest 単体/統合テスト</td>
            <td>519</td>
            <td>518</td>
            <td>1</td>
            <td><span class="badge badge-warn">1 KNOWN</span></td>
          </tr>
          <tr>
            <td colspan="5" style="font-size:12px;color:var(--color-text-muted);padding-left:28px;">
              不合格1件: 画像リサイズテスト（img_4642.jpg: 4284px）-- Windows環境のsharpファイルロック問題（既知）。本番Linux環境では問題なし
            </td>
          </tr>
          <tr>
            <td>CMS CRUDエビデンス</td>
            <td>48</td>
            <td>48</td>
            <td>0</td>
            <td><span class="badge badge-pass">ALL AUTH OK</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<hr class="divider">

<!-- 7. 技術知見 -->
<section class="section">
  <div class="container">
    <h2 class="section-title"><span class="section-num">7</span> 得られた技術知見</h2>

    <div class="card">
      <h3>Decap CMS OAuth 3ステップハンドシェイク</h3>
      <p style="margin-bottom:12px;">実際のOAuth認証フロー（<code>functions/auth/callback.js</code>）は以下の3段階で動作する:</p>
      <table>
        <thead><tr><th>Step</th><th>送信元</th><th>メッセージ</th><th>宛先</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>ポップアップ</td><td><code>"authorizing:github"</code></td><td>親ウィンドウ（CMS）</td></tr>
          <tr><td>2</td><td>親ウィンドウ（CMS）</td><td>ACKメッセージ</td><td>ポップアップ</td></tr>
          <tr><td>3</td><td>ポップアップ</td><td><code>"authorization:github:success:" + JSON.stringify({token, provider})</code></td><td>親ウィンドウ（CMS）</td></tr>
        </tbody>
      </table>
      <p style="margin-top:12px;font-size:13px;color:var(--color-text-muted);">ステップ1-2を省略してトークンを直接送信すると、CMSはメッセージを無視する。</p>
    </div>

    <div class="card">
      <h3>Playwright制約と対策</h3>
      <table>
        <thead><tr><th>制約</th><th>対策</th></tr></thead>
        <tbody>
          <tr><td><code>page.route()</code>はポップアップナビゲーションをインターセプトできない</td><td><code>context.route()</code>（ブラウザコンテキストレベル）を使用</td></tr>
          <tr><td>glob <code>**/auth</code>はクエリパラメータ付きURLにマッチしない</td><td>関数マッチャー（<code>url => url.pathname === '/auth'</code>）を使用</td></tr>
          <tr><td>ルートのマッチ順がLIFO（後登録が先にチェック）</td><td>catch-allを最初に登録、具体ルートを後から登録</td></tr>
          <tr><td>config.ymlのbase_urlがリモートURLだとpostMessageがクロスオリジン拒否</td><td>エビデンス収集時はbase_urlをlocalhostに一時変更（コミット前に復元必須）</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<hr class="divider">

<!-- 8. 再発防止策 -->
<section class="section">
  <div class="container">
    <h2 class="section-title"><span class="section-num">8</span> 再発防止策</h2>

    <div class="card">
      <table>
        <thead>
          <tr><th>#</th><th>対策</th><th>実施状況</th><th>根拠</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>エビデンス提出前の社内レビュー義務化</td>
            <td><span class="badge badge-pass">実施済</span></td>
            <td>CLAUDE.md ルール11</td>
          </tr>
          <tr>
            <td>2</td>
            <td>バグ修正内容のドキュメント反映義務化</td>
            <td><span class="badge badge-pass">実施済</span></td>
            <td>CLAUDE.md バグフロー5</td>
          </tr>
          <tr>
            <td>3</td>
            <td>エビデンス収集認証方式の技術ノート文書化</td>
            <td><span class="badge badge-pass">実施済</span></td>
            <td>DOCUMENTATION.md 4.9.8章</td>
          </tr>
          <tr>
            <td>4</td>
            <td>Bug #36を過去バグ検証マトリクスに追加</td>
            <td><span class="badge badge-pass">実施済</span></td>
            <td>DOCUMENTATION.md 4.9.5章</td>
          </tr>
          <tr>
            <td>5</td>
            <td>エビデンスフォルダ構成の整理・不要ファイル削除</td>
            <td><span class="badge badge-pass">実施済</span></td>
            <td>evidence/2026-02-23/</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="report-footer">
  <div class="container">
    <p>作業完了報告書 -- Bug #36修正・CMS CRUDエビデンス再取得</p>
    <p>tbiのブログ (reiwa.casa) -- Generated by Claude Code -- 2026-02-24</p>
  </div>
</footer>

</body>
</html>
